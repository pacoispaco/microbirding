<section id="observations-section" class="mb-left-section">
  <div class="mb-card">
    <!-- Navigation header with date links -->
    <div class="mb-card-header">
      <h2 class="text-sm font-semibold">{{ year }}</h2>
      {% if is_today %}
        <button
          hx-get="/hx/observations-section?date={{ previous_date }}"
          hx-push-url="?date={{ previous_date }}"
          hx-trigger="click"
          hx-target="#observations-section"
          hx-disabled-elt="this"
          class="text-sm px-4 rounded-md text-blue-800 dark:text-blue-200 hover:bg-neutral-100 dark:hover:bg-neutral-700 active:bg-neutral-200 dark:active:bg-neutral-600">

          &#x27E8; Dagen före

          <!-- inline spinner (shown only while request runs) -->
          <svg class="htmx-indicator animate-spin h-4 w-4" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
          </svg>
        </button>
        <span class="text-sm font-semibold">{{ day }}</span>
      {% else %}
        <button
          hx-get="/hx/observations-section?date={{ previous_date }}"
          hx-push-url="?date={{ previous_date }}"
          hx-trigger="click"
          hx-target="#observations-section"
          hx-disabled-elt="this"
          class="text-sm px-4 rounded-md text-blue-800 dark:text-blue-200 hover:bg-neutral-100 dark:hover:bg-neutral-700 active:bg-neutral-200 dark:active:bg-neutral-600">

          &#x27E8; Dagen före

          <!-- inline spinner (shown only while request runs) -->
          <svg class="htmx-indicator animate-spin h-4 w-4" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
          </svg>
        </button>
        <span class="text-sm font-semibold">{{ day }}</span>
        <button
          hx-get="/hx/observations-section?date={{ next_date }}"
          hx-push-url="?date={{ next_date }}"
          hx-trigger="click"
          hx-target="#observations-section"
          hx-disabled-elt="this"
          class="text-sm px-4 rounded-md text-blue-800 dark:text-blue-200 hover:bg-neutral-100 dark:hover:bg-neutral-700 active:bg-neutral-200 dark:active:bg-neutral-600">

          Dagen efter &#x27E9;

          <!-- inline spinner (shown only while request runs) -->
          <svg class="htmx-indicator animate-spin h-4 w-4" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
          </svg>
        </button>
      {% endif %}
    </div>

    <!-- Table with observations for larger than mobile displays -->
    <table class="hidden lg:table w-full table-fixed border-collapse divide-y divide-neutral-200 dark:divide-neutral-700">
      <colgroup>
        <col class="w-[17%]">
        <col class="w-[23%]">
        <col class="w-[10%]">
        <col class="w-[20%]">
        <col class="w-[22%]">
        <col class="w-[6%]">
      </colgroup>

      <thead class="table-header-group">
        <tr>
          <th class="text-sm text-left px-3 py-2">Art</th>
          <th class="text-sm text-left px-3 py-2">Detaljer</th>
          <th class="text-sm text-left px-3 py-2">Tid</th>
          <th class="text-sm text-left px-3 py-2">Lokal</th>
          <th class="text-sm text-left px-3 py-2">Observatör</th>
          <th class="text-sm text-left px-3 py-2">Källa</th>
        </tr>
      </thead>

      <tbody class="table-row-group text-sm divide-y divide-neutral-200 dark:divide-neutral-700 [&>tr>td]:px-3 [&>tr>td]:py-2">
        {% if observations %}
          {% if observations[0] == "Failed" %}
             <li class="p-3 bg-neutral-50 dark:bg-neutral-800/70 italic text-red-600">
              Failed to get observations, probably due to Artportalens API returning HTTP status code 429 (Too Many Requests).
            </li>
          {% else %}
            {% for o in observations %}
              <tr>
                <td class="align-baseline truncate text-base">{{ o.name }}</td>
                <td class="align-baseline truncate">
                  {% if o.number %}
                    {{ o.number }}
                  {% endif %}
                  {% if o.age %}
                    {{ o.age }}
                  {% endif %}
                  {% if o.sex.symbol %}
                    {% if o.sex.en == 'female coloured' %}
                      {{ o.sex.sv }}
                    {% else %}
                      <i class="fa-solid {{ o.sex.symbol }} sex-icon" 
                         aria-label="{{ o.sex.sv }}"
                         title="{{ o.sex.sv }}">
                      </i>
                    {% endif %}
                  {% endif %}
                  {% if o.activity %}
                    {{ o.activity }}
                  {% endif %}
                  {% if o.redlistCategory %}
                    ({{ o.redlistCategory }})
                  {% endif %}
                </td>
                <td class="align-baseline truncate">{{ o.time }}</td>
                <td class="align-baseline truncate">{{ o.locality }}</td>
                <td class="align-baseline truncate">{{ o.observers }}</td>
                <td class="align-baseline truncate">
                  {% if o.data_source_observation_url %}
                    <div class="text-sm">
                      <a href="{{ o.data_source_observation_url }}" target="_blank"
                         class="text-blue-800 dark:text-blue-200 rounded-md px-1 py-0.5 hover:bg-neutral-100 dark:hover:bg-neutral-700">
                        {{ o.data_source_abbreviation }}
                      </a>
                    </div>
                  {% else %}
                    <div class="text-sm italic text-red-600">
                      Failed to get source info, probably due to Artportalens API returning HTTP status code 429 (Too Many Requests).
                    </div>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          {% endif %}
        {% endif %}
      </tbody>
    </table>

    <!-- Grid with observations for smaller mobile displays -->
    <div class="grid grid-cols-1 lg:hidden divide-y divide-neutral-200 dark:divide-neutral-700">
        
      {% if observations %}
        {% if observations[0] == "Failed" %}
          <div class="p-3 bg-neutral-50 dark:bg-neutral-800/70 italic text-red-600">
            Failed to get observations, probably due to Artportalens API returning HTTP status code 429 (Too Many Requests).
          </div>
        {% else %}
          {% for o in observations %}
            <div class="p-3 text-sm">
              <div class="grid [grid-template-columns:42%_33%_23%] items-baseline">
                <div class="text-base">{{ o.name }}</div>
                <div class="truncate">{{ o.locality }}</div>
                <div class="text-right">{{ o.time }}</div>
              </div>
              <div class="grid [grid-template-columns:42%_35%_23%] pt-1 text-xs">
                <div class="truncate pl-2">
                  {% if o.number %}
                    {{ o.number }}
                  {% endif %}
                  {% if o.age %}
                    {{ o.age }}
                  {% endif %}
                  {% if o.sex.symbol %}
                    {% if o.sex.en == 'female coloured' %}
                      {{ o.sex.sv }}
                    {% else %}
                      <i class="fa-solid {{ o.sex.symbol }} sex-icon" 
                         aria-label="{{ o.sex.sv }}"
                         title="{{ o.sex.sv }}">
                      </i>
                    {% endif %}
                  {% endif %}
                  {% if o.activity %}
                    {{ o.activity }}
                  {% endif %}
                  {% if o.redlistCategory %}
                    ({{ o.redlistCategory }})
                  {% endif %}
                </div>
                <div class="truncate">{{ o.observers }}</div>
                <div class="text-right">
                  {% if o.data_source_observation_url.startswith("http") %}
                    <a href="{{ o.data_source_observation_url }}" target="_blank"
                       class="text-blue-800 dark:text-blue-200 rounded-md px-1 py-0.5 hover:bg-neutral-100 dark:hover:bg-neutral-700">
                      {{ o.data_source_abbreviation }}
                    </a>
                  {% else %}
                    {{ o.data_source_abbreviation }} ({{ o.data_source_observation_url }})
                  {% endif %}
                </div>
              </div>
            </div>
          {% endfor %}
        {% endif %}
      {% endif %}
    </div>

  </div>

</section>
