name: CI

on:
  push:
    branches: [ main ]
    tags:
      - "*"   # build on any tag push; we validate SemVer in the job

permissions:
  contents: read
  packages: write

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      TZ: Europe/Stockholm

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install tooling (flake8 + pytest placeholder)
        run: |
          python -m pip install --upgrade pip
          pip install flake8 pytest

      - name: Run flake8
        run: flake8 --config flake8.conf

      - name: Install Tailwind CLI-program
        run: |
          curl -sLO https://github.com/tailwindlabs/tailwindcss/releases/download/v4.1.18/tailwindcss-linux-x64
          chmod +x tailwindcss-linux-x64
          mv tailwindcss-linux-x64 tailwindcss

      - name: Generate the minimized Tailwind CSS file
        run: ./tailwindcss -m -i ./tailwind.css -o ./app/resources/tailwind.css

      - name: Run pytest (placeholder)
        run: |
          echo "TODO: add real tests"
          pytest -q || echo "No tests yet (placeholder step)"

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Compute image name
        run: |
          OWNER_LC=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          echo "IMAGE_NAME=ghcr.io/${OWNER_LC}/microbirding" >> "$GITHUB_ENV"

      - name: Validate SemVer tag (tags only)
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          TAG="${GITHUB_REF_NAME}"

          # SemVer 2.0.0 (prerelease/build optional)
          # Examples accepted:
          # 0.1.0
          # 0.1.0-rc.1
          # 1.2.3-alpha.1+build.45
          SEMVER_REGEX='^(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)(-([0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*))?(\+([0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*))?$'

          if ! [[ "$TAG" =~ $SEMVER_REGEX ]]; then
            echo "ERROR: Tag '$TAG' is not a valid SemVer 2.0.0 version."
            exit 1
          fi

          echo "Tag '$TAG' is valid SemVer."

      - name: Build, tag and push image
        shell: bash
        run: |
          set -euo pipefail

          # Short git hash for tagging
          GIT_HASH="$(git rev-parse --short=12 HEAD)"
          echo "Git hash: $GIT_HASH"

          # Build datetime
          BUILD_DATETIME="$(date +"%Y-%m-%d %H:%M")"
          echo "Build datetime: $BUILD_DATETIME"

          TAG_SHA="${IMAGE_NAME}:${GIT_HASH}"

          if [[ "${GITHUB_REF}" == "refs/heads/main" ]]; then
            # Push to main => sha + dev
            TAG_ENV="${IMAGE_NAME}:dev"
            RELEASE_TAG="dev"
            DOCKER_TAGS=(-t "$TAG_SHA" -t "$TAG_ENV")
            PUSH_TAGS=("$TAG_SHA" "$TAG_ENV")
            echo "Trigger: main branch push"
          else
            # Tag push => validate already ran => sha + git tag (+ latest if pure X.Y.Z)
            TAG_NAME="${GITHUB_REF_NAME}"
            TAG_VER="${IMAGE_NAME}:${TAG_NAME}"
            RELEASE_TAG="${TAG_NAME}"

            DOCKER_TAGS=(-t "$TAG_SHA" -t "$TAG_VER")
            PUSH_TAGS=("$TAG_SHA" "$TAG_VER")

            # latest only if exactly Major.Minor.Patch (no prerelease/build)
            if [[ "$TAG_NAME" =~ ^(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)$ ]]; then
              TAG_LATEST="${IMAGE_NAME}:latest"
              DOCKER_TAGS+=(-t "$TAG_LATEST")
              PUSH_TAGS+=("$TAG_LATEST")
              echo "Pure semver detected; also tagging :latest"
            fi

            echo "Trigger: tag push ($TAG_NAME)"
          fi

          echo "Tagging Docker image as: ${PUSH_TAGS[*]}"

          docker build --pull \
            "${DOCKER_TAGS[@]}" \
            --build-arg RELEASE_TAG="$RELEASE_TAG" \
            --build-arg BUILD_DATETIME="$BUILD_DATETIME" \
            --build-arg GIT_HASH="$GIT_HASH" \
            .

          for t in "${PUSH_TAGS[@]}"; do
            docker push "$t"
          done

